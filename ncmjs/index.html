<html>
	<head>
		<title>.ncm converter</title>
		<script src="https://cdn.rawgit.com/ricmoo/aes-js/e27b99df/index.js"></script>
		<script src="https://ahohnmyc.github.io/FLACMetadataEditor/FLACMetadataEditor.js"></script>
		<script src="https://unpkg.com/browser-id3-writer@4.4.0/dist/browser-id3-writer.js"></script>
		<script>
		var b64s;
		function msToTime(s) {
			function pad(n, z) {
				z = z || 2;
				return ('00' + n).slice(-z);
			}
			var ms = s % 1000;
			s = (s - ms) / 1000;
			var secs = s % 60;
			s = (s - secs) / 60;
			var mins = s % 60;
			var hrs = (s - mins) / 60;
			return pad(hrs) + ':' + pad(mins) + ':' + pad(secs) + '.' + pad(ms, 3);
		}
		function base64download(mime, fn, ImageBase64){
			var ae = document.createElement("a");
			ae.href = "data:"+mime+";base64," + ImageBase64;
			ae.download = fn;
			ae.click();
		}
		function arrayBufferToBase64( buffer ) {
			var binary = '';
			var bytes = buffer;
			var len = bytes.length;
			for (var i = 0; i < len; i++) {
				binary += String.fromCharCode( bytes[ i ] );
			}
			return window.btoa( binary );
		}
		function lit(stri){
			sum = 0
			for (var x=3;x>-1;x--){
				sum = sum << 8
				sum = sum + stri.charCodeAt(x)
			}
			return sum
		}
		function unpad(str) {
			return str.substring(0,str.length-str.charCodeAt(str.length-1));
		}
		function decode(str){
			tmpstr = '';
			for (var x = 0; x<str.length; x++){
				tmpstr2 = str[x].charCodeAt(0).toString(16)
				while (tmpstr2.length < 2){
					tmpstr2 = '0' + tmpstr2;
				}
				tmpstr = tmpstr + '%' + tmpstr2;
			}
			return decodeURIComponent(tmpstr);
		}
		function transfer(){
			console.log("--- Start ---");
			var a = document.getElementById('ncm');
			if (a.files.length == 0){
				document.getElementById('after').innerHTML = '<p style="color:red">Please Upload an ncm file!</p>';
				return false;
			}
			else if (a.files[0].name.split('.').pop() != 'ncm'){
				document.getElementById('after').innerHTML = '<p style="color:red">File type incorrect. Please Upload an ncm file!</p>';
				return false;
			}
			var fileobj = a.files[0];
			var reader = new FileReader();
			var pointer = 0
			reader.onload = function (e){
				var con = e.target.result;
				console.log("--- File Readed ---");
				var head = con.substring(pointer, pointer + 8);
				pointer = pointer + 8;
				console.log("--- Checking Header ---")
				if (head != 'CTENFDAM'){
					console.error("--- Header Incorrect, exit... ---")
					document.getElementById('after').innerHTML = '<p style="color:red">File Corrupt or invalid ncm file. Please try again.</p>';
					return false;
				}
				console.log("--- Decrypting S Box_Key Data ---")
				pointer = pointer + 2;
				key_length = lit(con.substring(pointer, pointer + 4));
				pointer = pointer + 4;
				key_data = con.substring(pointer, pointer + key_length);
				pointer = key_length + pointer;
				key_data = key_data.split("");
				for (var x = 0; x < key_data.length; x++){
					key_data[x] = String.fromCharCode(key_data[x].charCodeAt(0)^100);
				}
				key_data = key_data.join('');
				var core_key = [104, 122, 72, 82, 65, 109, 115, 111, 53, 107, 73, 110, 98, 97, 120, 87];
				var meta_key = [35, 49, 52, 108, 106, 107, 95, 33, 92, 93, 38, 48, 85, 60, 39, 40];
				var key_data_array = new Uint8Array(key_data.length);
				for (var x = 0; x < key_data.length; x++){
					key_data_array[x] = key_data.charCodeAt(x);
				}
				var cryptor = new aesjs.ModeOfOperation.ecb(core_key);
				var key_data_unc_array = cryptor.decrypt(key_data_array);
				var key_data_unc = '';
				for (var x = 0; x < key_data_unc_array.length; x++){
					key_data_unc = key_data_unc + String.fromCharCode(key_data_unc_array[x]);
				}
				key_data = unpad(key_data_unc).substring(17);
				key_length = key_data.length;
				var key = key_data.split("");
				for (var x = 0; x < key.length; x++){
					key[x] = key[x].charCodeAt(0);
				}
				console.log("--- Constructing S_Box ---")
				var S = [];
				for (var x = 0; x < 256; x++){
					S[x] = x;
				}
				var j = 0;
				var tmp = 0;
				for (var i = 0; i < 256; i++){
					j = (j + S[i] + key[i % key_length]) & 255;
					tmp = S[i];
					S[i] = S[j];
					S[j] = tmp;
				}
				console.log("--- Decrypting MetaData ---")
				var meta_length = lit(con.substring(pointer, pointer + 4));
				pointer = pointer + 4;
				if (meta_length != 0){
					meta_data = con.substring(pointer, pointer + meta_length);
					pointer = pointer + meta_length;
					meta_data = meta_data.split("");
					for (var x = 0; x < meta_data.length; x++){
						meta_data[x] = String.fromCharCode(meta_data[x].charCodeAt(0) ^ 99);
					}
					meta_data = meta_data.join('');
					identifier = decode(meta_data);
					meta_data = atob(meta_data.substring(22));
					var meta_data_array = new Uint8Array(meta_data.length);
					for (var x = 0; x < meta_data.length; x++){
						meta_data_array[x] = meta_data.charCodeAt(x);
					}
					cryptor = new aesjs.ModeOfOperation.ecb(meta_key);
					var meta_data_unc_array = cryptor.decrypt(meta_data_array);
					var meta_data_unc = '';
					for (var x = 0; x < meta_data_unc_array.length; x++){
						meta_data_unc = meta_data_unc + String.fromCharCode(meta_data_unc_array[x]);
					}
					meta_data = decode(unpad(meta_data_unc));
					console.log("--- MetaData Found ---")
					meta_data = JSON.parse(meta_data.substring(6));
					var art = meta_data.artist;
					var art2 = [];
					for (var x = 0; x < art.length; x++){
						art2 = art2.concat([art[x][0]]);
					}
				}
				else {
					console.log("--- MetaData Not Found, Generating ---")
					var meta_data = {'format':(con.length>(1024 ** 2 * 16) ? 'flac' : 'mp3')};
				}
				pointer = pointer + 5;
				console.log("--- Retriving Image Data ---")
				var image_space = lit(con.substring(pointer, pointer+4));
				pointer = pointer + 4;
				var image_size = lit(con.substring(pointer, pointer+4));
				pointer = pointer + 4;
				if (image_size != 0){
					console.log("--- Image Found ---")
					var image_data = con.substring(pointer, pointer+image_size);
					pointer = pointer + image_size;
				}
				pointer = pointer + (image_space - image_size);
				var data = con.substring(pointer);
				console.log("--- Generating Stream ---")
				var streamv = [];
				for (var i = 0; i < 256; i++){
					streamv[i] = S[(S[i] + S[(i + S[i]) & 255]) & 255];
				}
				console.log(streamv[0], streamv[1], streamv[2]);
				var stream = streamv.slice(1).concat([streamv[0]]);
				console.log(stream[0], stream[1], stream[2]);
				data = data.split('');
				for (var x = 0; x < data.length; x++){
					data[x] = String.fromCharCode(data[x].charCodeAt(0) ^ stream[x%256]);
				}
				databuff = Uint8Array.from(data, c => c.charCodeAt(0));			
				if (meta_data.format == 'flac'){
					var audio = new FLACMetadataEditor(databuff);
				}
				else if (meta_data.format == 'mp3'){
					var audio = new ID3Writer(databuff);
				}
				if (image_data){
					console.log(image_data.substring(0, 4));
					var mimet = (image_data.substring(0, 4) == '\x89PNG' ? 'image/png' : 'image/jpeg')
					console.log(mimet);
					var imbuff = Uint8Array.from(image_data, c => c.charCodeAt(0));
					if (meta_data.format == 'flac'){
						audio.addPicture({
							APICtype: 6,
							MIMEType: mimet,
							colorDepth: 0,
							colorNumber: 0,
							data: imbuff,
							description: '',
							width: 0,
							height: 0
						});
						audio.serializeMetadata();
					}
					else if (meta_data.format == 'mp3'){
						audio.setFrame('APIC', {
							type: 6,
							data: imbuff,
							MIMEType: mimet,
							description: ''
						});
						audio.addTag();
					}
				}
				if (meta_length){
					if (meta_data.format == 'flac'){
						audio.addComment('DESCRIPTION', identifier);
						audio.addComment('TITLE', meta_data.musicName);
						audio.addComment('ALBUM', meta_data.album);
						audio.addComment('ARTIST', art2.join('/'));
						audio.serializeMetadata();
					}
					else{
						audio.setFrame('COMM', identifier);
						audio.setFrame('TIT2', meta_data.musicName);
						audio.setFrame('TALB', meta_data.album);
						audio.setFrame('TOPE', art2.join('/'));
						audio.addTag();
					}
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Metadata Found.</p>';
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">--- Metadata ---</p>';
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Music Name: '+meta_data['musicName']+'</p>';
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Artist: '+art2.join(', ')+'</p>';
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Album: '+meta_data['album']+'</p>';
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Duration: '+msToTime(meta_data['duration'])+'</p>';
					if (typeof meta_data['alias'] != 'undefined' && meta_data['alias'] != null){
						for (var x = 0; x < meta_data['alias'].length; x++){
							document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Alias'+x+': '+meta_data['alias'][x]+'</p>';
						}
					}
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Alias: '+msToTime(meta_data['duration'])+'</p>';
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:green">Format: '+meta_data['format']+'</p>';
				}
				else {
					document.getElementById('after').innerHTML = document.getElementById('after').innerHTML + '<p style="color:red">No Metadata</p>';
				}
				var res = new Uint8Array(audio.arrayBuffer);
				var filename = document.getElementById('ncm').files[0].name.split('.');
				filename.pop();
				filename = filename.join('.');
				filename = filename + '.' + meta_data.format;
				document.getElementById('after').innerHTML = '<p style="color:green">Success! Download the file as <button id="dl">'+filename.replace('<', '\\<').replace('>', '\\>')+'</button></p>' + document.getElementById('after').innerHTML;
				var db = document.getElementById('dl');
				db.onclick = function(){base64download((meta_data.format == 'flac' ? 'audio/flac' : 'audio/mpeg'), filename, arrayBufferToBase64(res))};
			}
			reader.readAsBinaryString(a.files[0]);
			return false;
		}
		</script>
	</head>
	<body>
		<form onsubmit="return transfer();">.ncm file: <input type=file id='ncm' accept=".ncm"></input><input type=submit></input></form>
		<div id='after'></div>
	</body>
</html>